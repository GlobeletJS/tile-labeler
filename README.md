# tile-labeler

Convert map label features into WebGL buffers for rendering

Feature layout is guided by a [MapLibre style document][MapLibre], as parsed by
[tile-stencil][]. The returned buffers are consistent with the format
returned by [tile-mixer][].

See the [simple test][] plotting computed character positions over a
pre-rendered tile.

[MapLibre]: https://maplibre.org/maplibre-gl-js-docs/style-spec/layers/#symbol
[tile-stencil]: https://github.com/GlobeletJS/tile-stencil
[tile-mixer]: https://github.com/GlobeletJS/tile-mixer
[simple test]: https://globeletjs.github.io/tile-labeler/examples/maptiler-basic/

![tests](https://github.com/GlobeletJS/tile-labeler/actions/workflows/node.js.yml/badge.svg)

## Installation
tile-labeler is provided as an ESM import
```javascript
import * as tileLabeler from 'tile-labeler';
```

tileLabeler exposes two methods:
- initAtlasGetter
- initShaping

## initAtlasGetter
Returns a function that collects font names and character codes for each
label, and constructs an atlas of glyph SDFs (via [sdf-manager][]).

[sdf-manager]: https://github.com/GlobeletJS/sdf-manager

### Syntax
```javascript
const getAtlas = tileLabeler.initAtlasGetter(params);
```

### Parameters
The supplied parameters object has the following properties:
- `parsedStyles` (Array): An array of MapLibre style layers, with style functions
  already parsed by [tile-stencil][]
- `glyphEndpoint` (String): The URL template from the [glyphs][] property of a
  MapLibre style document. Any Mapbox-specific domains or API keys must have been
  already expanded by [tile-stencil][]

[glyphs]: https://maplibre.org/maplibre-gl-js-docs/style-spec/glyphs/

### API
The returned atlas getter function inputs tile data, and returns a Promise that
resolves to an atlas of glyph SDFs.
For example,
```javascript
getAtlas(layers, zoom).then(atlas => {
  // Use atlas to shape label features and construct WebGL buffers
});
```

The parameters for the getAtlas function are:
- `layers` (Object): A dictionary of tile layers, keyed on the `.id` property 
  of the style for that layer. (NOTE: this is probably NOT the natural order 
  of the tile data&mdash;it should be pre-filtered. See filter-source.js in 
  [tile-mixer].) Each layer should have a `.features` property pointing to
  an array of GeoJSON features.
- `zoom` (Number): The zoom level at which style `layout` functions will be
  evaluated

The data returned from the labeler function includes:
- `{ width, height, data } = atlas`: The signed distance field (SDF) data to
  be loaded as an Alpha texture. `data` is a Uint16Array

NOTE also that any label features in layer.features will have the following
properties added (MODIFIED IN PLACE):
- `feature.font` (String): The name of the font used to render this label
- `feature.charCodes` (Array): The character codes of the characters in the
  label text

## initShaping
Returns a function that constructs WebGL buffers for valid label features.

### Syntax
```javascript
const shaper = tileLabeler.initShaping(style, spriteData);
```

### Arguments
- `style`: A 'symbol' layer from a [MapLibre style document][MapLibre], with 
  the `.layout` property parsed into value getters by [tile-stencil][].
- `spriteData`: The data retrieved by [tile-stencil][] from the URL described
  in the [sprite property of the style document][sprite]

[sprite]: https://maplibre.org/maplibre-gl-js-docs/style-spec/sprite/

### API
The returned shaper function has the following signature:
```javascript
const buffers = shaper(feature, zoom, atlas, tree);
```

where the arguments are as follows:
- `feature`: A GeoJSON feature, to which the properties `.font` and `.charCodes`
  have been added by a previous call to a getAtlas function (see above under
  initAtlasGetter).
- `zoom`: The map zoom level at which this label will be displayed
- `atlas`: An atlas of glyph SDFs, as generated by the getAtlas call
- `tree`: An [rbush][] object used for checking collisions with previous labels.
  The user is responsible for initializing this object, and supplying layers
  in the correct order.

[rbush]: https://github.com/mourner/rbush
